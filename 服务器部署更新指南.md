# 服务器部署更新指南 - 羽毛球分析系统

## 概述
在CentOS服务器上更新部署最新的图片访问功能修复

## 前提条件
- 服务器已部署羽毛球分析系统
- 使用Daphne作为ASGI服务器
- 项目路径：`/var/www/badminton-analysis`（根据实际情况调整）

## 更新步骤

### 第1步：连接服务器
```bash
# SSH连接到你的腾讯云服务器
ssh root@YOUR_SERVER_IP
# 或者
ssh username@YOUR_SERVER_IP
```

### 第2步：停止当前服务
```bash
# 查找并停止Daphne进程
ps aux | grep daphne
pkill -f daphne

# 或者如果使用systemd服务
sudo systemctl stop badminton-analysis
```

### 第3步：备份当前代码（可选但推荐）
```bash
cd /var/www/
cp -r badminton-analysis badminton-analysis-backup-$(date +%Y%m%d-%H%M%S)
```

### 第4步：更新代码
```bash
cd /var/www/badminton-analysis

# 检查当前状态
git status
git log --oneline -3

# 拉取最新代码
git fetch origin
git pull origin master

# 验证更新
git log --oneline -3
```

### 第5步：检查环境和依赖
```bash
# 激活虚拟环境（如果使用）
source venv/bin/activate

# 检查Python依赖
pip list | grep -E "(django|daphne|matplotlib|numpy|scipy)"

# 如果需要安装新依赖
pip install -r requirements.txt
```

### 第6步：数据库迁移（如果有模型更改）
```bash
python manage.py makemigrations
python manage.py migrate
```

### 第7步：创建必要目录并设置权限
```bash
# 创建images目录
mkdir -p /var/www/badminton-analysis/images
chmod 755 /var/www/badminton-analysis/images

# 创建staticfiles目录
mkdir -p /var/www/badminton-analysis/staticfiles
chmod 755 /var/www/badminton-analysis/staticfiles

# 收集静态文件
python manage.py collectstatic --noinput
```

### 第8步：测试配置
```bash
# 测试Django配置
python manage.py check

# 测试图片生成功能
python -c "import matplotlib; matplotlib.use('Agg'); import matplotlib.pyplot as plt; print('matplotlib OK')"
```

### 第9步：重启服务
```bash
# 方式1：直接启动Daphne
cd /var/www/badminton-analysis
nohup daphne -b 0.0.0.0 -p 8000 djangodemo.asgi:application > daphne.log 2>&1 &

# 方式2：如果使用systemd
sudo systemctl start badminton-analysis
sudo systemctl enable badminton-analysis

# 方式3：使用screen
screen -S badminton
daphne -b 0.0.0.0 -p 8000 djangodemo.asgi:application
# 按Ctrl+A+D退出screen
```

### 第10步：验证部署
```bash
# 检查进程
ps aux | grep daphne

# 检查端口
netstat -tlnp | grep :8000

# 测试基本连接
curl http://localhost:8000/

# 测试新的API
curl http://localhost:8000/api/debug_images/
curl http://localhost:8000/api/miniprogram/get_images/
```

## 服务器端图片功能测试

### 自动化测试脚本
```bash
# 下载并运行测试脚本
cd /var/www/badminton-analysis

# 运行Python测试脚本（需要修改SERVER_IP）
python test_daphne_images.py localhost

# 或者运行shell测试脚本
chmod +x server_image_debug.sh
./server_image_debug.sh
```

### 手动测试步骤
```bash
# 1. 测试图片目录
ls -la /var/www/badminton-analysis/images/

# 2. 测试图片生成
curl -X POST http://localhost:8000/api/debug_images/ -d 'action=regenerate'

# 3. 检查生成的图片
ls -la /var/www/badminton-analysis/images/

# 4. 测试图片访问
curl -I http://localhost:8000/images/test_analysis_curve.jpg

# 5. 测试小程序API
curl http://localhost:8000/api/miniprogram/get_images/
```

## 常见问题排查

### 问题1：图片生成失败
```bash
# 检查matplotlib
python -c "import matplotlib; print('OK')"

# 检查目录权限
ls -la /var/www/badminton-analysis/
chmod 755 /var/www/badminton-analysis/images/

# 检查磁盘空间
df -h
```

### 问题2：静态文件访问失败
```bash
# 检查settings.py配置
grep -n "MEDIA" /var/www/badminton-analysis/djangodemo/settings.py

# 检查URL配置
grep -A 10 -B 5 "serve" /var/www/badminton-analysis/djangodemo/urls.py
```

### 问题3：API访问失败
```bash
# 检查Django日志
tail -f /var/www/badminton-analysis/daphne.log

# 检查URL配置
python manage.py show_urls | grep -E "(debug_images|miniprogram)"
```

### 问题4：权限问题
```bash
# 修复所有权限
sudo chown -R www-data:www-data /var/www/badminton-analysis/
sudo chmod -R 755 /var/www/badminton-analysis/
sudo chmod -R 777 /var/www/badminton-analysis/images/
```

## 防火墙配置

### CentOS 7 (firewalld)
```bash
# 开放8000端口
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --reload

# 检查开放端口
sudo firewall-cmd --list-ports
```

### 腾讯云安全组
1. 登录腾讯云控制台
2. 进入云服务器 → 安全组
3. 添加规则：
   - 协议：TCP
   - 端口：8000
   - 来源：0.0.0.0/0

## 性能优化建议

### 生产环境配置
```bash
# 修改settings.py
echo "DEBUG = False" >> /var/www/badminton-analysis/djangodemo/settings.py

# 设置ALLOWED_HOSTS
# 编辑settings.py，添加服务器IP
```

### 使用Gunicorn + Daphne
```bash
# 安装Gunicorn
pip install gunicorn

# 创建启动脚本
cat > /var/www/badminton-analysis/start_server.sh << 'EOF'
#!/bin/bash
cd /var/www/badminton-analysis
source venv/bin/activate
daphne -b 0.0.0.0 -p 8000 djangodemo.asgi:application
EOF

chmod +x /var/www/badminton-analysis/start_server.sh
```

## 监控和维护

### 日志监控
```bash
# 实时监控日志
tail -f /var/www/badminton-analysis/daphne.log

# 监控系统资源
htop
df -h
free -h
```

### 定期维护
```bash
# 清理旧图片（保留最近7天）
find /var/www/badminton-analysis/images/ -type f -mtime +7 -name "*.jpg" -delete

# 定期备份数据库
python manage.py dumpdata > backup_$(date +%Y%m%d).json
```

## 完整部署验证清单

- [ ] 服务器连接正常
- [ ] Git代码更新成功
- [ ] Python依赖安装完成
- [ ] 数据库迁移完成
- [ ] images目录创建并有正确权限
- [ ] Daphne服务启动成功
- [ ] 端口8000监听正常
- [ ] 基本API访问正常
- [ ] 图片生成功能正常
- [ ] 小程序API返回正确
- [ ] 防火墙端口开放
- [ ] 外网访问测试通过

---

**部署完成后测试URL：**
- 主页：`http://YOUR_SERVER_IP:8000/`
- 图片调试：`http://YOUR_SERVER_IP:8000/api/debug_images/`
- 小程序API：`http://YOUR_SERVER_IP:8000/api/miniprogram/get_images/`
- 图片访问：`http://YOUR_SERVER_IP:8000/images/latest_multi_sensor_curve.jpg` 