# 羽毛球分析系统 - 图片访问问题解决指南

## 问题描述
前端和后台都无法查看到生成的最新分析图片。

## 问题原因分析

1. **路径配置不一致**：图片生成和访问使用了不同的路径
2. **Nginx静态文件配置缺失**：没有正确配置图片文件的静态服务
3. **权限问题**：图片目录权限不正确
4. **路径映射错误**：Django MEDIA设置与实际文件路径不匹配

## 解决方案

### 1. 检查和修复代码配置

已修复的问题：
- ✅ 统一了图片生成路径（使用`MEDIA_ROOT`）
- ✅ 修复了`latest_analysis_images`函数的路径查找逻辑
- ✅ 添加了详细的调试信息和日志
- ✅ 增强了图片生成函数的错误处理

### 2. 新增的调试API

#### 图片调试API
```bash
# 获取图片调试信息
GET http://your_server_ip/api/debug_images/

# 强制重新生成测试图片
POST http://your_server_ip/api/debug_images/
Content-Type: application/x-www-form-urlencoded
action=regenerate

# 清理旧图片
POST http://your_server_ip/api/debug_images/
Content-Type: application/x-www-form-urlencoded
action=cleanup
```

#### 图片列表API
```bash
# 列出所有可用图片
GET http://your_server_ip/api/list_images/
```

### 3. 服务器端检查步骤

#### 步骤1：运行调试脚本
```bash
# 上传并运行服务器调试脚本
chmod +x server_image_debug.sh
./server_image_debug.sh
```

#### 步骤2：检查目录权限
```bash
# 确保images目录存在且权限正确
sudo mkdir -p /var/www/badminton-analysis/images
sudo chmod 755 /var/www/badminton-analysis/images
sudo chown www-data:www-data /var/www/badminton-analysis/images
```

#### 步骤3：测试图片生成
```bash
# 通过API测试图片生成
curl -X POST http://localhost:8000/api/debug_images/ -d 'action=regenerate'

# 检查图片是否生成
ls -la /var/www/badminton-analysis/images/
```

### 4. Nginx配置

#### 使用提供的配置模板
1. 复制`nginx_image_config_template.conf`到`/etc/nginx/sites-available/badminton`
2. 修改其中的域名和IP地址
3. 创建软链接：`sudo ln -s /etc/nginx/sites-available/badminton /etc/nginx/sites-enabled/`
4. 测试配置：`sudo nginx -t`
5. 重启Nginx：`sudo systemctl restart nginx`

#### 关键配置部分
```nginx
location /images/ {
    alias /var/www/badminton-analysis/images/;
    expires 30d;
    add_header Cache-Control "public, immutable";
    add_header Access-Control-Allow-Origin *;
}
```

### 5. 测试和验证

#### 本地测试
```bash
# 1. 测试Django API
curl http://localhost:8000/api/debug_images/

# 2. 测试图片生成
curl -X POST http://localhost:8000/api/debug_images/ -d 'action=regenerate'

# 3. 测试图片访问
curl -I http://localhost:8000/images/test_analysis_curve.jpg
```

#### 远程测试
```bash
# 替换YOUR_SERVER_IP为实际服务器IP
# 1. 测试API访问
curl http://YOUR_SERVER_IP/api/debug_images/

# 2. 测试图片访问
curl -I http://YOUR_SERVER_IP/images/latest_multi_sensor_curve.jpg

# 3. 浏览器访问
# http://YOUR_SERVER_IP/images/latest_multi_sensor_curve.jpg
```

### 6. 常见问题排查

#### 问题1：图片生成失败
**症状**：API调用成功但图片文件不存在
**解决**：
```bash
# 检查Python matplotlib是否正确安装
python -c "import matplotlib; matplotlib.use('Agg'); import matplotlib.pyplot as plt; print('OK')"

# 检查目录权限
ls -la /var/www/badminton-analysis/images/
```

#### 问题2：图片访问404
**症状**：图片文件存在但HTTP访问返回404
**解决**：
```bash
# 检查Nginx配置
sudo nginx -t
sudo tail -f /var/log/nginx/error.log

# 重启Nginx
sudo systemctl restart nginx
```

#### 问题3：权限被拒绝
**症状**：Permission denied错误
**解决**：
```bash
# 修复目录权限
sudo chown -R www-data:www-data /var/www/badminton-analysis/images/
sudo chmod -R 755 /var/www/badminton-analysis/images/

# 检查SELinux (如果启用)
sudo setsebool -P httpd_can_network_connect 1
```

### 7. 最终验证清单

- [ ] Django服务正常运行
- [ ] images目录存在且权限正确
- [ ] 可以通过API生成测试图片
- [ ] 图片文件在服务器上可见
- [ ] Nginx配置包含静态文件处理
- [ ] 可以通过HTTP访问图片URL
- [ ] 前端可以正常显示图片

### 8. 监控和维护

#### 日志监控
```bash
# Django日志
tail -f /path/to/django.log

# Nginx访问日志
tail -f /var/log/nginx/badminton_access.log

# Nginx错误日志
tail -f /var/log/nginx/badminton_error.log
```

#### 定期检查
```bash
# 每日检查脚本
#!/bin/bash
# 检查图片目录空间使用
du -sh /var/www/badminton-analysis/images/

# 检查最新图片文件
ls -lat /var/www/badminton-analysis/images/ | head -5

# 测试图片API
curl -s http://localhost:8000/api/list_images/ | jq '.media_images | length'
```

## 联系和支持

如果按照以上步骤仍无法解决问题，请提供以下信息：

1. 运行`server_image_debug.sh`的完整输出
2. Django和Nginx的错误日志
3. 调试API的响应结果
4. 服务器系统信息和配置

---

**最后更新**：2024年1月9日
**版本**：1.0 