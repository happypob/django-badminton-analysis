<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket连接测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #45a049;
        }
        .button.disconnect {
            background-color: #f44336;
        }
        .button.disconnect:hover {
            background-color: #da190b;
        }
        .log {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>羽毛球分析系统 - WebSocket连接测试</h1>
    
    <!-- ESP32设备测试 -->
    <div class="section">
        <h2>ESP32设备测试</h2>
        <div>
            <label>设备编码: </label>
            <input type="text" id="esp32DeviceCode" value="2025001" placeholder="设备编码">
            <button class="button" onclick="connectESP32()">连接ESP32</button>
            <button class="button disconnect" onclick="disconnectESP32()">断开ESP32</button>
        </div>
        <div id="esp32Status" class="status disconnected">未连接</div>
        
        <h3>ESP32指令测试</h3>
        <div>
            <button class="button" onclick="sendESP32Heartbeat()">发送心跳</button>
            <button class="button" onclick="sendESP32PollCommands()">轮询指令</button>
            <button class="button" onclick="sendESP32StatusUpdate()">状态更新</button>
            <button class="button" onclick="sendESP32SensorData()">发送传感器数据</button>
            <button class="button" onclick="sendESP32UploadComplete()">上传完成</button>
        </div>
        
        <h3>ESP32消息日志</h3>
        <div id="esp32Log" class="log"></div>
    </div>
    
    <!-- 小程序测试 -->
    <div class="section">
        <h2>小程序测试</h2>
        <div>
            <label>用户ID: </label>
            <input type="text" id="miniprogramUserId" value="test_user_123" placeholder="用户ID">
            <button class="button" onclick="connectMiniProgram()">连接小程序</button>
            <button class="button disconnect" onclick="disconnectMiniProgram()">断开小程序</button>
        </div>
        <div id="miniprogramStatus" class="status disconnected">未连接</div>
        
        <h3>小程序指令测试</h3>
        <div>
            <button class="button" onclick="sendMiniprogramSessionStatus()">查询会话状态</button>
        </div>
        
        <h3>小程序消息日志</h3>
        <div id="miniprogramLog" class="log"></div>
    </div>
    
    <!-- 管理后台测试 -->
    <div class="section">
        <h2>管理后台测试</h2>
        <div>
            <button class="button" onclick="connectAdmin()">连接管理后台</button>
            <button class="button disconnect" onclick="disconnectAdmin()">断开管理后台</button>
        </div>
        <div id="adminStatus" class="status disconnected">未连接</div>
        
        <h3>管理后台指令测试</h3>
        <div>
            <button class="button" onclick="getSystemStatus()">获取系统状态</button>
            <button class="button" onclick="getDeviceList()">获取设备列表</button>
        </div>
        
        <h3>管理后台消息日志</h3>
        <div id="adminLog" class="log"></div>
    </div>

    <script>
        let esp32Socket = null;
        let miniprogramSocket = null;
        let adminSocket = null;
        
        // 获取WebSocket URL的基础部分
        const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsHost = location.host;
        
        // ESP32连接测试
        function connectESP32() {
            const deviceCode = document.getElementById('esp32DeviceCode').value;
            if (!deviceCode) {
                alert('请输入设备编码');
                return;
            }
            
            if (esp32Socket) {
                esp32Socket.close();
            }
            
            const wsUrl = `${wsProtocol}//${wsHost}/ws/esp32/${deviceCode}/`;
            esp32Socket = new WebSocket(wsUrl);
            
            esp32Socket.onopen = function(event) {
                updateStatus('esp32Status', true, 'ESP32已连接');
                logMessage('esp32Log', 'ESP32 WebSocket连接已建立');
            };
            
            esp32Socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                logMessage('esp32Log', `收到消息: ${JSON.stringify(data, null, 2)}`);
            };
            
            esp32Socket.onclose = function(event) {
                updateStatus('esp32Status', false, 'ESP32已断开');
                logMessage('esp32Log', 'ESP32 WebSocket连接已关闭');
            };
            
            esp32Socket.onerror = function(error) {
                logMessage('esp32Log', `ESP32连接错误: ${error}`);
            };
        }
        
        function disconnectESP32() {
            if (esp32Socket) {
                esp32Socket.close();
                esp32Socket = null;
            }
        }
        
        // 小程序连接测试
        function connectMiniProgram() {
            const userId = document.getElementById('miniprogramUserId').value;
            if (!userId) {
                alert('请输入用户ID');
                return;
            }
            
            if (miniprogramSocket) {
                miniprogramSocket.close();
            }
            
            const wsUrl = `${wsProtocol}//${wsHost}/ws/miniprogram/${userId}/`;
            miniprogramSocket = new WebSocket(wsUrl);
            
            miniprogramSocket.onopen = function(event) {
                updateStatus('miniprogramStatus', true, '小程序已连接');
                logMessage('miniprogramLog', '小程序 WebSocket连接已建立');
            };
            
            miniprogramSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                logMessage('miniprogramLog', `收到消息: ${JSON.stringify(data, null, 2)}`);
            };
            
            miniprogramSocket.onclose = function(event) {
                updateStatus('miniprogramStatus', false, '小程序已断开');
                logMessage('miniprogramLog', '小程序 WebSocket连接已关闭');
            };
            
            miniprogramSocket.onerror = function(error) {
                logMessage('miniprogramLog', `小程序连接错误: ${error}`);
            };
        }
        
        function disconnectMiniProgram() {
            if (miniprogramSocket) {
                miniprogramSocket.close();
                miniprogramSocket = null;
            }
        }
        
        // 管理后台连接测试
        function connectAdmin() {
            if (adminSocket) {
                adminSocket.close();
            }
            
            const wsUrl = `${wsProtocol}//${wsHost}/ws/admin/`;
            adminSocket = new WebSocket(wsUrl);
            
            adminSocket.onopen = function(event) {
                updateStatus('adminStatus', true, '管理后台已连接');
                logMessage('adminLog', '管理后台 WebSocket连接已建立');
            };
            
            adminSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                logMessage('adminLog', `收到消息: ${JSON.stringify(data, null, 2)}`);
            };
            
            adminSocket.onclose = function(event) {
                updateStatus('adminStatus', false, '管理后台已断开');
                logMessage('adminLog', '管理后台 WebSocket连接已关闭');
            };
            
            adminSocket.onerror = function(error) {
                logMessage('adminLog', `管理后台连接错误: ${error}`);
            };
        }
        
        function disconnectAdmin() {
            if (adminSocket) {
                adminSocket.close();
                adminSocket = null;
            }
        }
        
        // ESP32指令测试函数
        function sendESP32Heartbeat() {
            if (!esp32Socket) {
                alert('请先连接ESP32');
                return;
            }
            
            const message = {
                type: 'heartbeat',
                session_id: '123',
                device_code: document.getElementById('esp32DeviceCode').value,
                status: 'collecting'
            };
            
            esp32Socket.send(JSON.stringify(message));
            logMessage('esp32Log', `发送心跳: ${JSON.stringify(message)}`);
        }
        
        function sendESP32PollCommands() {
            if (!esp32Socket) {
                alert('请先连接ESP32');
                return;
            }
            
            const message = {
                type: 'poll_commands',
                device_code: document.getElementById('esp32DeviceCode').value,
                current_session: '123',
                status: 'idle'
            };
            
            esp32Socket.send(JSON.stringify(message));
            logMessage('esp32Log', `轮询指令: ${JSON.stringify(message)}`);
        }
        
        function sendESP32StatusUpdate() {
            if (!esp32Socket) {
                alert('请先连接ESP32');
                return;
            }
            
            const message = {
                type: 'status_update',
                status: 'START_COLLECTION_CONFIRMED',
                session_id: '123',
                device_code: document.getElementById('esp32DeviceCode').value
            };
            
            esp32Socket.send(JSON.stringify(message));
            logMessage('esp32Log', `状态更新: ${JSON.stringify(message)}`);
        }
        
        function sendESP32SensorData() {
            if (!esp32Socket) {
                alert('请先连接ESP32');
                return;
            }
            
            const message = {
                type: 'sensor_data',
                sensor_type: 'waist',
                data: {
                    acc: [1.2, 0.8, 9.8],
                    gyro: [0.1, 0.2, 0.3],
                    angle: [45.0, 30.0, 60.0]
                },
                session_id: '123',
                timestamp: Date.now()
            };
            
            esp32Socket.send(JSON.stringify(message));
            logMessage('esp32Log', `传感器数据: ${JSON.stringify(message)}`);
        }
        
        function sendESP32UploadComplete() {
            if (!esp32Socket) {
                alert('请先连接ESP32');
                return;
            }
            
            const message = {
                type: 'upload_complete',
                session_id: '123'
            };
            
            esp32Socket.send(JSON.stringify(message));
            logMessage('esp32Log', `上传完成: ${JSON.stringify(message)}`);
        }
        
        // 小程序指令测试函数
        function sendMiniprogramSessionStatus() {
            if (!miniprogramSocket) {
                alert('请先连接小程序');
                return;
            }
            
            const message = {
                type: 'session_status',
                session_id: '123'
            };
            
            miniprogramSocket.send(JSON.stringify(message));
            logMessage('miniprogramLog', `查询会话状态: ${JSON.stringify(message)}`);
        }
        
        // 管理后台指令测试函数
        function getSystemStatus() {
            if (!adminSocket) {
                alert('请先连接管理后台');
                return;
            }
            
            const message = {
                type: 'get_system_status'
            };
            
            adminSocket.send(JSON.stringify(message));
            logMessage('adminLog', `获取系统状态: ${JSON.stringify(message)}`);
        }
        
        function getDeviceList() {
            if (!adminSocket) {
                alert('请先连接管理后台');
                return;
            }
            
            const message = {
                type: 'get_device_list'
            };
            
            adminSocket.send(JSON.stringify(message));
            logMessage('adminLog', `获取设备列表: ${JSON.stringify(message)}`);
        }
        
        // 工具函数
        function updateStatus(elementId, connected, message) {
            const element = document.getElementById(elementId);
            element.className = connected ? 'status connected' : 'status disconnected';
            element.textContent = message;
        }
        
        function logMessage(logElementId, message) {
            const logElement = document.getElementById(logElementId);
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // 页面加载时清空日志
        window.onload = function() {
            document.getElementById('esp32Log').innerHTML = '';
            document.getElementById('miniprogramLog').innerHTML = '';
            document.getElementById('adminLog').innerHTML = '';
        };
    </script>
</body>
</html> 