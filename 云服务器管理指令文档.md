# 🏸 羽毛球分析系统 - 云服务器管理指令文档

## 📋 服务器信息
- **服务器类型**: 腾讯云 OpenCloudOS
- **服务器IP**: 175.178.100.179
- **项目目录**: `/root/badminton-analysis` 或 `/opt/badminton-analysis`
- **Python环境**: venv虚拟环境
- **数据库**: SQLite
- **Web框架**: Django 5.2.5

---

## 🚀 基础服务器操作

### SSH连接
```bash
# SSH连接到服务器
ssh root@175.178.100.179

# 或使用密钥连接
ssh -i /path/to/your/key.pem root@175.178.100.179
```

### 系统信息查看
```bash
# 查看系统信息
uname -a
cat /etc/os-release

# 查看资源使用情况
htop
df -h              # 磁盘使用
free -h            # 内存使用
lscpu              # CPU信息
```

---

## 📂 项目目录管理

### 进入项目目录
```bash
# 进入项目目录
cd /root/badminton-analysis
# 或
cd /opt/badminton-analysis

# 激活虚拟环境
source venv/bin/activate

# 验证环境
which python
python --version
```

### 项目结构查看
```bash
# 查看项目结构
ls -la

# 查看重要文件
ls -la wxapp/
ls -la djangodemo/
ls -la images/
```

---

## 🔄 代码版本管理

### Git操作
```bash
# 查看当前状态
git status
git log --oneline -10

# 拉取最新代码
git pull origin master

# 如果网络问题，增加超时时间
git config --global http.timeout 120
git config --global http.postBuffer 524288000

# 查看远程仓库
git remote -v

# 重置到最新版本（谨慎使用）
git reset --hard origin/master
```

### 手动更新（网络问题时）
```bash
# 备份当前配置
cp djangodemo/settings.py djangodemo/settings.py.backup

# 手动修改关键配置
vim djangodemo/settings.py
# 确保 ALLOWED_HOSTS = ['localhost', '127.0.0.1', '175.178.100.179']
```

---

## 🐍 Python环境管理

### 虚拟环境操作
```bash
# 激活虚拟环境
source venv/bin/activate

# 停用虚拟环境
deactivate

# 查看已安装包
pip list

# 安装依赖
pip install -r requirements.txt

# 升级pip
pip install --upgrade pip
```

### 依赖管理
```bash
# 查看项目依赖
cat requirements.txt

# 安装科学计算库（如果缺失）
pip install numpy scipy matplotlib pandas

# 验证关键包
python -c "import django; print(django.VERSION)"
python -c "import numpy; print(numpy.__version__)"
python -c "import matplotlib; print(matplotlib.__version__)"
```

---

## 🌐 Django服务管理

### 启动和停止服务
```bash
# 启动Django开发服务器
python manage.py runserver 0.0.0.0:8000

# 后台启动（推荐）
nohup python manage.py runserver 0.0.0.0:8000 > django.log 2>&1 &

# 查看所有Python进程
ps aux | grep python

# 停止Django服务
pkill -f "python.*manage.py.*runserver"

# 强制停止
pkill -9 -f "python.*manage.py.*runserver"
```

### 服务状态检查
```bash
# 检查端口监听
netstat -tlnp | grep 8000
lsof -i :8000

# 查看Django进程
ps aux | grep "manage.py runserver"

# 查看后台任务
jobs

# 实时查看日志
tail -f django.log

# 查看最近日志
tail -50 django.log
```

---

## 🧪 功能测试

### 本地测试
```bash
# 测试基本服务
curl http://localhost:8000/

# 测试图片API
curl http://localhost:8000/wxapp/latest_analysis_images/

# 测试特定接口
curl http://localhost:8000/wxapp/login/
curl http://localhost:8000/admin/
```

### 外网测试
```bash
# 从服务器测试外网访问
curl http://175.178.100.179:8000/

# 测试图片API外网访问
curl http://175.178.100.179:8000/wxapp/latest_analysis_images/

# 测试图片文件访问
curl -I http://175.178.100.179:8000/images/latest_multi_sensor_curve.jpg
```

### 健康检查
```bash
# Django系统检查
python manage.py check

# 数据库检查
python manage.py dbshell
.tables
.exit

# 静态文件检查
python manage.py collectstatic --dry-run
```

---

## 💾 数据库管理

### SQLite操作
```bash
# 进入数据库shell
python manage.py dbshell

# 在SQLite中执行命令
.tables                          # 查看所有表
.schema wxapp_analysisresult     # 查看表结构
SELECT COUNT(*) FROM wxapp_analysisresult;  # 查询数据
.exit                           # 退出
```

### Django数据库命令
```bash
# 查看迁移状态
python manage.py showmigrations

# 执行迁移
python manage.py migrate

# 创建超级用户
python manage.py createsuperuser

# 数据库shell
python manage.py shell
```

---

## 📊 图片功能管理

### 图片目录管理
```bash
# 查看图片目录
ls -la images/

# 查找图片文件
find images/ -name "*.jpg" -o -name "*.png"

# 检查图片大小
du -sh images/*

# 清理旧图片（谨慎使用）
find images/ -name "*.jpg" -mtime +30 -delete
```

### 手动生成图片
```bash
# 通过Django shell生成图片
python manage.py shell -c "
from wxapp.models import DataCollectionSession
from wxapp.views import extract_angular_velocity_data, generate_multi_sensor_curve
session = DataCollectionSession.objects.filter(id=2).first()
if session:
    angle_data = extract_angular_velocity_data(session)
    time_labels = angle_data['time_labels']
    sensor_data = {
        'waist': angle_data['waist_data'],
        'shoulder': angle_data['shoulder_data'],
        'wrist': angle_data['wrist_data'],
        'racket': angle_data['racket_data']
    }
    sensor_data = {k: v for k, v in sensor_data.items() if v and any(val != 0 for val in v)}
    if sensor_data and time_labels:
        generate_multi_sensor_curve(sensor_data, time_labels)
        print('图片生成成功')
    else:
        print('无有效数据生成图片')
else:
    print('会话不存在')
"
```

---

## 🔧 系统维护

### 日志管理
```bash
# 查看Django日志
tail -f django.log
tail -100 django.log

# 查看系统日志
tail -f /var/log/messages
journalctl -f

# 清理日志（谨慎使用）
> django.log  # 清空Django日志
```

### 磁盘空间管理
```bash
# 查看磁盘使用
df -h

# 查看目录大小
du -sh *
du -sh /root/badminton-analysis

# 清理临时文件
find /tmp -type f -mtime +7 -delete

# 查找大文件
find / -type f -size +100M 2>/dev/null
```

### 内存和进程管理
```bash
# 查看内存使用
free -h
cat /proc/meminfo

# 查看进程资源使用
top
htop

# 查找占用内存最多的进程
ps aux --sort=-%mem | head -10

# 清理内存缓存（如果需要）
sync && echo 3 > /proc/sys/vm/drop_caches
```

---

## 🔒 安全和网络

### 防火墙管理
```bash
# 查看防火墙状态
firewall-cmd --state
firewall-cmd --list-all

# 开放8000端口（如果需要）
firewall-cmd --permanent --add-port=8000/tcp
firewall-cmd --reload

# 查看开放的端口
firewall-cmd --list-ports
```

### 网络诊断
```bash
# 测试网络连接
ping github.com
ping google.com

# 查看网络配置
ip addr show
netstat -tuln

# 测试端口连通性
telnet 175.178.100.179 8000
nc -zv 175.178.100.179 8000
```

---

## 🚨 故障排除

### 常见问题诊断
```bash
# Django无法启动
python manage.py check
python manage.py runserver --verbosity=3

# 端口被占用
lsof -i :8000
kill -9 [PID]

# 权限问题
ls -la manage.py
chmod +x manage.py

# Python路径问题
which python
echo $PATH
```

### 错误日志分析
```bash
# 查看Django错误
grep -i error django.log
grep -i exception django.log

# 查看系统错误
dmesg | tail
journalctl -xe

# 检查磁盘错误
dmesg | grep -i "I/O error"
```

### 重启恢复操作
```bash
# 完全重启服务
pkill -f python
cd /root/badminton-analysis
source venv/bin/activate
nohup python manage.py runserver 0.0.0.0:8000 > django.log 2>&1 &

# 验证服务启动
ps aux | grep python
curl http://localhost:8000/
```

---

## 📋 快速运维脚本

### 服务状态检查脚本
```bash
#!/bin/bash
echo "=== 羽毛球分析系统状态检查 ==="
echo "时间: $(date)"
echo "服务器IP: 175.178.100.179"
echo ""

echo "1. Django进程状态:"
ps aux | grep "manage.py runserver" | grep -v grep || echo "Django服务未运行"

echo ""
echo "2. 端口监听状态:"
netstat -tlnp | grep 8000 || echo "8000端口未监听"

echo ""
echo "3. 磁盘使用情况:"
df -h | grep -E "(/$|/root)"

echo ""
echo "4. 内存使用情况:"
free -h

echo ""
echo "5. 最近5分钟的日志错误:"
tail -100 django.log | grep -i error | tail -5
```

### 服务重启脚本
```bash
#!/bin/bash
echo "=== 重启羽毛球分析系统 ==="

# 停止当前服务
echo "停止当前Django服务..."
pkill -f "python.*manage.py.*runserver"
sleep 2

# 进入项目目录
cd /root/badminton-analysis

# 激活虚拟环境
source venv/bin/activate

# 启动服务
echo "启动Django服务..."
nohup python manage.py runserver 0.0.0.0:8000 > django.log 2>&1 &

sleep 3

# 验证启动
echo "验证服务状态..."
ps aux | grep "manage.py runserver" | grep -v grep && echo "✅ Django服务启动成功" || echo "❌ Django服务启动失败"

# 测试访问
curl -s http://localhost:8000/ > /dev/null && echo "✅ 本地访问正常" || echo "❌ 本地访问失败"
```

---

## 📞 紧急联系和备份

### 重要文件备份
```bash
# 备份关键配置文件
cp djangodemo/settings.py backup_settings_$(date +%Y%m%d).py
cp db.sqlite3 backup_db_$(date +%Y%m%d).sqlite3

# 备份整个项目（定期执行）
tar -czf badminton_backup_$(date +%Y%m%d).tar.gz /root/badminton-analysis
```

### 系统信息记录
```bash
# 记录系统配置
uname -a > system_info.txt
pip list > requirements_current.txt
git log --oneline -20 > git_history.txt
```

---

**文档版本**: v1.0
**最后更新**: 2025年9月1日
**适用系统**: 腾讯云 OpenCloudOS
**维护者**: 羽毛球分析系统运维团队

> 💡 **提示**: 请定期备份重要数据，在执行危险操作前务必先备份相关文件。 