{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}分析结果{% endblock %}

{% block content %}
<div class="module">
    <h2>羽毛球动作分析结果</h2>
    
    {% if session %}
    <div class="session-info">
        <h3>会话信息</h3>
        <p><strong>会话ID:</strong> {{ session.id }}</p>
        <p><strong>开始时间:</strong> {{ session.start_time }}</p>
        <p><strong>结束时间:</strong> {{ session.end_time|default:"未结束" }}</p>
        <p><strong>状态:</strong> {{ session.get_status_display }}</p>
    </div>
    {% endif %}
    
    {% if report %}
    <div class="analysis-results">
        <h3>综合评分</h3>
        <div class="score-cards">
            <div class="score-card">
                <h4>总体评分</h4>
                <div class="score">{{ report.summary.overall_score }}/100</div>
            </div>
            <div class="score-card">
                <h4>时序评分</h4>
                <div class="score">{{ report.summary.delay_score }}/100</div>
            </div>
            <div class="score-card">
                <h4>能量评分</h4>
                <div class="score">{{ report.summary.energy_score }}/100</div>
            </div>
            <div class="score-card">
                <h4>关节活动度评分</h4>
                <div class="score">{{ report.summary.rom_score }}/100</div>
            </div>
        </div>
        
        <!-- 角速度曲线图部分 -->
        <div class="analysis-section">
            <h4>角速度时序分析</h4>
            <p class="chart-description">下图显示了各传感器角速度随时间的变化，用于分析发力时序和延迟。</p>
            
            <div class="chart-container">
                <canvas id="angularVelocityChart" width="800" height="400"></canvas>
            </div>
            
            <div class="chart-legend">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #FF6384;"></span>
                    <span>腰部传感器</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #36A2EB;"></span>
                    <span>肩部传感器</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #FFCE56;"></span>
                    <span>腕部传感器</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #4BC0C0;"></span>
                    <span>球拍传感器</span>
                </div>
            </div>
            
            <div class="delay-analysis">
                <h5>时序延迟分析</h5>
                <div class="delay-info">
                    <p><strong>腰部→肩部峰值延迟:</strong> <span id="waist-shoulder-delay">{{ report.phase_analysis.waist_to_shoulder_delay }}ms</span></p>
                    <p><strong>肩部→腕部峰值延迟:</strong> <span id="shoulder-wrist-delay">{{ report.phase_analysis.shoulder_to_wrist_delay }}ms</span></p>
                    <p><strong>腕部→球拍峰值延迟:</strong> <span id="wrist-racket-delay">{{ report.phase_analysis.wrist_to_racket_delay|default:"计算中..." }}ms</span></p>
                </div>
            </div>
        </div>
        
        <div class="analysis-section">
            <h4>详细分析</h4>
            
            <div class="analysis-subsection">
                <h5>时序分析</h5>
                <table class="analysis-table">
                    <tr>
                        <td>腰部→肩部延迟:</td>
                        <td>{{ report.phase_analysis.waist_to_shoulder_delay }}ms (理想: {{ report.phase_analysis.ideal_waist_to_shoulder }}ms)</td>
                    </tr>
                    <tr>
                        <td>肩部→腕部延迟:</td>
                        <td>{{ report.phase_analysis.shoulder_to_wrist_delay }}ms (理想: {{ report.phase_analysis.ideal_shoulder_to_wrist }}ms)</td>
                    </tr>
                    <tr>
                        <td>评估:</td>
                        <td>{{ report.phase_analysis.delay_assessment }}</td>
                    </tr>
                </table>
            </div>
            
            <div class="analysis-subsection">
                <h5>能量分析</h5>
                <table class="analysis-table">
                    <tr>
                        <td>能量传递效率:</td>
                        <td>{{ report.energy_analysis.energy_ratio }}% (理想: {{ report.energy_analysis.ideal_ratio }}%)</td>
                    </tr>
                    <tr>
                        <td>评估:</td>
                        <td>{{ report.energy_analysis.energy_assessment }}</td>
                    </tr>
                </table>
            </div>
            
            <div class="analysis-subsection">
                <h5>关节活动度分析</h5>
                <table class="analysis-table">
                    <tr>
                        <td>腰部旋转:</td>
                        <td>{{ report.rom_analysis.waist_rotation }}° (理想: {{ report.rom_analysis.ideal_waist }}°)</td>
                    </tr>
                    <tr>
                        <td>肩部屈伸:</td>
                        <td>{{ report.rom_analysis.shoulder_flexion }}° (理想: {{ report.rom_analysis.ideal_shoulder }}°)</td>
                    </tr>
                    <tr>
                        <td>腕部背屈:</td>
                        <td>{{ report.rom_analysis.wrist_extension }}° (理想: {{ report.rom_analysis.ideal_wrist }}°)</td>
                    </tr>
                    <tr>
                        <td>评估:</td>
                        <td>{{ report.rom_analysis.rom_assessment }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="analysis-section">
            <h4>改进建议</h4>
            <ul class="recommendations">
                {% for recommendation in report.recommendations %}
                <li>{{ recommendation }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
    
    <div class="actions">
        <a href="{% url 'admin:upload_mat' %}" class="button">上传新文件</a>
        <a href="{% url 'admin:index' %}" class="button">返回管理后台</a>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// 角速度曲线图数据
const chartData = {
    labels: JSON.parse('{{ report.angular_velocity_data.time_labels|escapejs }}'),
    datasets: [
        {
            label: '腰部传感器',
            data: JSON.parse('{{ report.angular_velocity_data.waist_data|escapejs }}'),
            borderColor: '#FF6384',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4
        },
        {
            label: '肩部传感器',
            data: JSON.parse('{{ report.angular_velocity_data.shoulder_data|escapejs }}'),
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4
        },
        {
            label: '腕部传感器',
            data: JSON.parse('{{ report.angular_velocity_data.wrist_data|escapejs }}'),
            borderColor: '#FFCE56',
            backgroundColor: 'rgba(255, 206, 86, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4
        },
        {
            label: '球拍传感器',
            data: JSON.parse('{{ report.angular_velocity_data.racket_data|escapejs }}'),
            borderColor: '#4BC0C0',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4
        }
    ]
};

// 创建图表
const ctx = document.getElementById('angularVelocityChart').getContext('2d');
const angularVelocityChart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: '各传感器角速度时序变化'
            },
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: '时间 (ms)'
                }
            },
            y: {
                title: {
                    display: true,
                    text: '角速度 (rad/s)'
                }
            }
        },
        interaction: {
            intersect: false,
            mode: 'index'
        }
    }
});

// 计算峰值延迟
function calculatePeakDelays() {
    const datasets = chartData.datasets;
    const labels = chartData.labels;
    
    // 找到各传感器的峰值时间
    const peakTimes = datasets.map(dataset => {
        const maxIndex = dataset.data.indexOf(Math.max(...dataset.data));
        return labels[maxIndex];
    });
    
    // 计算延迟
    const delays = [];
    for (let i = 1; i < peakTimes.length; i++) {
        delays.push(peakTimes[i] - peakTimes[i-1]);
    }
    
    // 更新显示
    if (delays.length >= 1) {
        document.getElementById('waist-shoulder-delay').textContent = delays[0] + 'ms';
    }
    if (delays.length >= 2) {
        document.getElementById('shoulder-wrist-delay').textContent = delays[1] + 'ms';
    }
    if (delays.length >= 3) {
        document.getElementById('wrist-racket-delay').textContent = delays[2] + 'ms';
    }
}

// 页面加载完成后计算延迟
document.addEventListener('DOMContentLoaded', calculatePeakDelays);
</script>

<style>
    .module {
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .session-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .score-cards {
        display: flex;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    
    .score-card {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        min-width: 150px;
    }
    
    .score {
        font-size: 24px;
        font-weight: bold;
        color: #1976d2;
    }
    
    .analysis-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
    }
    
    .analysis-subsection {
        margin: 15px 0;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 4px;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 10px;
    }
    
    .chart-description {
        color: #666;
        font-style: italic;
        margin-bottom: 15px;
    }
    
    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 15px 0;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 3px;
    }
    
    .delay-analysis {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 4px;
        margin-top: 15px;
    }
    
    .delay-info p {
        margin: 5px 0;
    }
    
    .analysis-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .analysis-table td {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    
    .analysis-table td:first-child {
        font-weight: bold;
        width: 200px;
    }
    
    .recommendations {
        list-style: none;
        padding: 0;
    }
    
    .recommendations li {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .recommendations li:before {
        content: "•";
        color: #1976d2;
        font-weight: bold;
        margin-right: 10px;
    }
    
    .actions {
        margin-top: 30px;
        text-align: center;
    }
    
    .button {
        display: inline-block;
        background: #79aec8;
        color: white;
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 4px;
        margin: 0 10px;
    }
    
    .button:hover {
        background: #417690;
        color: white;
    }
</style>
{% endblock %} 